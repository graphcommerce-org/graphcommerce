#!/usr/bin/env sh

# Track stash count to know if we created one
STASH_COUNT=$(git stash list | wc -l)

# Stash unstaged changes to preserve partial staging
git stash push --quiet --keep-index -m "pre-commit-stash"

# Check if a stash was actually created
NEW_STASH_COUNT=$(git stash list | wc -l)
STASH_CREATED=0
if [ "$NEW_STASH_COUNT" -gt "$STASH_COUNT" ]; then
  STASH_CREATED=1
fi

# Trap to ensure stash is always restored, even on early termination
cleanup() {
  if [ "$STASH_CREATED" -eq 1 ]; then
    git stash pop --quiet
  fi
}
trap cleanup EXIT

corepack yarn graphcommerce cleanup-interceptors
CLEANUP_EXIT=$?
if [ $CLEANUP_EXIT -ne 0 ]; then
  echo "cleanup-interceptors failed with exit code $CLEANUP_EXIT"
  exit $CLEANUP_EXIT
fi

npx pretty-quick --staged
PRETTY_EXIT=$?
if [ $PRETTY_EXIT -ne 0 ]; then
  echo "pretty-quick failed with exit code $PRETTY_EXIT"
  exit $PRETTY_EXIT
fi

# Re-stage any formatting changes made to staged files
git update-index --again
