#!/usr/bin/env sh

# Track stash count to know if we created one
STASH_COUNT=$(git stash list | wc -l)

# Stash unstaged changes to preserve partial staging
git stash push --quiet --keep-index -m "pre-commit-stash"

# Check if a stash was actually created
NEW_STASH_COUNT=$(git stash list | wc -l)

corepack yarn graphcommerce cleanup-interceptors
npx pretty-quick --staged
git update-index --again

# Restore unstaged changes only if we created a stash
if [ "$NEW_STASH_COUNT" -gt "$STASH_COUNT" ]; then
  git stash pop --quiet
fi
